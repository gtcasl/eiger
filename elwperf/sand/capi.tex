
\chapter{C application support}\label{sec:langC}
\section{C api}
\label{sec:capi}
The application code changes are similar to those for C++, inserting macros where needed. The header to be included is {\em lwperf\_c.h}. For example:
\begin{verbatim}
#include "stdio.h"
#include "stdlib.h"
static
int n = 1;

void sub1(int x) {
  if (x < n) {
    x = x + 1;
    printf("x = %d\n", x);
    sub1(x);
  }
}

#include "lwperf_c.h"

int main(){
  int x = 0, nx=0;
  double dp = 3.14;

  PERF_INIT;
  PERF_MPI(0,1);
  PERF_OPTS("x5550","gcc","capp.c","capp","tesla.",".log") ;
  char buf[26];

  printf("Enter number of repeats\n");
  fgets(buf,sizeof(buf)-2,stdin);
  char *endPtr;
  n = (int)strtol(buf, &endPtr, 10);
  if (endPtr == &(buf[0])) {
    printf("given string, \"%s\" has no initial number\n", buf);
    exit(1);
  }
  printf("n = %d\n", n);

  PERFLOG(sub1,IP(n)) ;
  PERFLOG(sub2,IP(nx),DP(dp));
  sub1(x);
  PERFSTOP(sub2,IP(nx),DP(dp));
  PERFSTOP(sub1,IP(n));
  PERF_FINAL;
  return 0;
}
\end{verbatim}

The PERFDECL macro is available for C use as it is in C++.
\section{C build}
\label{sec:cbuild}
As with C++, some simple portions of the C binding must be generated based on a scan of the sites defined in the application code. This scan is performed and the generated code is updated by the simple utility {\em updateLoggersC.sh} and supporting scripts {\em gencsave.body.sh}, and {\em ./gencsave.sh}. These scripts may be tailored to the user's application source code, in most cases by adjusting the definition of the {\em cfiles} variable at the top of {\em updateLoggersC.sh}.

The logger can be kept in sync with the user code with a simple makefile rule such as:
\begin{verbatim}
cperf._stop.h: $(CSRC) updateLoggersC.sh
        ./updateLoggersC.sh
\end{verbatim}

Compiling and linking mixed language code is often tricky. Here is an example that may be inspirational; further explanation is beyond the scope of this note. Several additional examples are included in the Make.c* build scripts.
\begin{verbatim}
mpicc.openmpi -g capp.c -D_USE_EIGER \
cperf.o eperf.o eigerformatter.o csvformatter.o diffrusage.o \
-lmpi_cxx -lstdc++ \
/home/baallan/sst/gatech/eiger-svn/api/gcc/libeigerInterface.a \
/usr/lib/libmysqlpp.a -lmysqlclient \
-o ../capp_u11c
\end{verbatim}

